<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full VR Body Game</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#start {
 position:absolute;
 top:50%; left:50%;
 transform:translate(-50%,-50%);
 padding:20px 40px;
 font-size:22px;
 background:#00ff00;
 border:none;
}
#info {
 position:absolute;
 top:10px;
 left:10px;
 color:white;
 font-family:Arial;
}
</style>
</head>
<body>

<button id="start">START VR</button>
<div id="info"></div>
<video id="video" autoplay playsinline style="display:none;"></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>

const info = document.getElementById("info");
const startBtn = document.getElementById("start");
const video = document.getElementById("video");

let scene, camera, renderer, cube;
let velocity = new THREE.Vector3();
let handsMeshes = [];

startBtn.onclick = async () => {

 try {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
   await DeviceMotionEvent.requestPermission();
   await DeviceOrientationEvent.requestPermission();
  }
 } catch(e){}

 startBtn.remove();
 init();
};

function init(){

info.innerHTML = "Requesting camera...";

navigator.mediaDevices.getUserMedia({video:true})
.then(stream=>{
 video.srcObject = stream;
 info.innerHTML = "Camera active";
})
.catch(err=>{
 info.innerHTML = "Camera blocked. Open in Chrome + HTTPS.";
});

// ===== THREE =====
scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
camera.position.set(0,0,5);

renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,2);
light.position.set(5,10,5);
scene.add(light);

const floor = new THREE.Mesh(
 new THREE.PlaneGeometry(50,50),
 new THREE.MeshStandardMaterial({color:0x222222})
);
floor.rotation.x = -Math.PI/2;
floor.position.y = -3;
scene.add(floor);

cube = new THREE.Mesh(
 new THREE.BoxGeometry(1,1,1),
 new THREE.MeshStandardMaterial({color:0x00ffff})
);
cube.position.set(0,-2,0);
scene.add(cube);

// hand spheres
for(let i=0;i<2;i++){
 let s = new THREE.Mesh(
  new THREE.SphereGeometry(0.3,32,32),
  new THREE.MeshStandardMaterial({color:0x00ff00})
 );
 s.visible = false;
 scene.add(s);
 handsMeshes.push(s);
}

// ===== HANDS =====
const hands = new Hands({
 locateFile: file =>
  `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({maxNumHands:2});

hands.onResults(results=>{
 if(results.multiHandLandmarks){
  results.multiHandLandmarks.forEach((lm,i)=>{
   const x = (lm[9].x - 0.5)*8;
   const y = -(lm[9].y - 0.5)*6;
   const z = -lm[9].z*8;

   const mesh = handsMeshes[i];
   mesh.visible = true;
   mesh.position.set(x,y,z);

   if(mesh.position.distanceTo(cube.position)<1.5){
    const dir = cube.position.clone().sub(mesh.position).normalize();
    velocity.add(dir.multiplyScalar(0.1));
   }
  });
 }
});

// ===== POSE (FEET) =====
const pose = new Pose({
 locateFile: file =>
  `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({modelComplexity:1});

pose.onResults(results=>{
 if(results.poseLandmarks){
  const l = results.poseLandmarks[27];
  const r = results.poseLandmarks[28];

  if(l && r){
   if(Math.abs(l.z-r.z) > 0.3){
    velocity.z -= 0.5; // kick
   }
  }
 }
});

const cam = new Camera(video,{
 onFrame: async ()=>{
  await hands.send({image:video});
  await pose.send({image:video});
 },
 width:640,
 height:480
});
cam.start();

// ===== GYRO =====
window.addEventListener("deviceorientation",(e)=>{
 camera.rotation.x = e.beta * Math.PI/180 * 0.4;
 camera.rotation.y = e.gamma * Math.PI/180 * 0.4;
});

// ===== WALKING =====
window.addEventListener("devicemotion",(e)=>{
 if(e.accelerationIncludingGravity.z > 13){
  camera.position.z -= 0.2;
 }
});

// ===== RENDER =====
function animate(){

 velocity.multiplyScalar(0.92);
 cube.position.add(velocity);

 renderer.setScissorTest(true);
 const w = window.innerWidth;
 const h = window.innerHeight;

 renderer.setViewport(0,0,w/2,h);
 renderer.setScissor(0,0,w/2,h);
 camera.position.x = -0.03;
 renderer.render(scene,camera);

 renderer.setViewport(w/2,0,w/2,h);
 renderer.setScissor(w/2,0,w/2,h);
 camera.position.x = 0.03;
 renderer.render(scene,camera);

 renderer.setScissorTest(false);

 requestAnimationFrame(animate);
}
animate();

}

</script>
</body>
</html>
